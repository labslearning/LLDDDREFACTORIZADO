{% extends 'base.html' %}

{% block content %}
<div class="container py-5">
    <div class="card p-4 p-md-5 shadow-lg border-0">
        <div class="card-header bg-white border-0 text-center pb-4">
            <h2 class="fw-bold text-primary-dark">
                <i class="fas fa-chalkboard-teacher me-2 text-primary"></i>
                Gestión de Matrículas
            </h2>
            <p class="text-muted">Asignación de cursos y gestión de ciclo de vida del estudiante.</p>
        </div>

        <div class="card-body bg-light rounded-3 border mb-5 p-4">
            <form method="POST">
                {% csrf_token %}
                <div class="row g-3 align-items-start"> <div class="col-md-5">
                        <label for="estudiante_select" class="form-label fw-bold small text-uppercase text-muted">
                            Estudiantes (Selección Múltiple)
                        </label>
                        <select name="estudiantes" id="estudiante_select" class="form-select select2" multiple required>
                            {% for estudiante in todos_los_estudiantes %}
                                <option value="{{ estudiante.id }}">
                                    {{ estudiante.last_name }} {{ estudiante.first_name }} ({{ estudiante.username }})
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text small text-muted mt-1">
                            <i class="fas fa-info-circle"></i> Haz clic para añadir varios estudiantes.
                        </div>
                    </div>

                    <div class="col-md-5">
                        <label for="curso_select" class="form-label fw-bold small text-uppercase text-muted">Curso Destino</label>
                        <select name="curso" id="curso_select" class="form-select select2" required>
                            <option value="">Seleccionar curso...</option>
                            {% for curso in cursos %}
                                <option value="{{ curso.id }}">
                                    {{ curso.get_grado_display }} {{ curso.seccion }} 
                                    (Ocupación: {{ curso.matriculados.count }}/{{ curso.capacidad_maxima }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-2 align-self-center"> <button type="submit" class="btn btn-success w-100 fw-bold shadow-sm" style="height: 42px;">
                            <i class="fas fa-users me-2"></i> Asignar Lote
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <hr class="border-secondary opacity-10 my-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0">Estudiantes Matriculados <span class="text-muted fs-6 fw-normal">({{ anio_escolar }})</span></h4>
            <span class="badge bg-primary rounded-pill">{{ estudiantes_con_curso|length }} Activos</span>
        </div>

        <div class="table-responsive rounded-3 border">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-dark text-white">
                    <tr>
                        <th scope="col" class="ps-3">Estudiante</th>
                        <th scope="col">Acudiente</th>
                        <th scope="col">Curso</th>
                        <th scope="col" class="text-center">Generar Docs</th> 
                        <th scope="col" class="text-center">Visibilidad Boletín</th> 
                        <th scope="col" class="text-center">Visibilidad Obs.</th> 
                        <th scope="col" class="text-center">Retirar</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    {% for item in estudiantes_con_curso %}
                    <tr>
                        <td class="ps-3">
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-dark">{{ item.user.last_name }} {{ item.user.first_name }}</span>
                                <code class="text-muted small">{{ item.user.username }}</code>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex flex-column small">
                                <span class="fw-semibold">{{ item.acudiente_nombre }}</span>
                                <span class="text-muted">{{ item.acudiente_username }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ item.curso.get_grado_display }} - {{ item.curso.seccion }}
                            </span>
                        </td>
                        
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <a href="{% url 'panel_generar_boletin' item.user.id %}" class="btn btn-outline-primary btn-sm" target="_blank" title="Ver Boletín Actual">
                                    <i class="fas fa-file-invoice"></i>
                                </a>
                                <a href="{% url 'generar_observador_pdf' item.user.id %}" class="btn btn-outline-dark btn-sm" target="_blank" title="Ver Observador Actual">
                                    <i class="fas fa-user-shield"></i>
                                </a>
                            </div>
                        </td>

                        <td class="text-center">
                            {% if item.matricula %}
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input toggle-permiso cursor-pointer" type="checkbox" 
                                       data-tipo="boletin" 
                                       data-estudiante-id="{{ item.user.id }}"
                                       id="bol-switch-{{ item.user.id }}"
                                       {% if item.matricula.puede_generar_boletin %}checked{% endif %}>
                            </div>
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if item.matricula %}
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input toggle-permiso cursor-pointer" type="checkbox" 
                                       data-tipo="observador" 
                                       data-estudiante-id="{{ item.user.id }}"
                                       id="obs-switch-{{ item.user.id }}"
                                       {% if item.matricula.puede_ver_observador %}checked{% endif %}>
                            </div>
                            {% else %}
                            <span class="text-muted small">-</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger btn-retirar shadow-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalRetirarEstudiante"
                                    data-estudiante-id="{{ item.user.id }}"
                                    data-estudiante-nombre="{{ item.user.get_full_name|default:item.user.username }}">
                                <i class="fas fa-user-times me-1"></i> Retirar
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">
                            <i class="fas fa-users-slash fa-3x mb-3 opacity-50"></i><br>
                            No hay estudiantes matriculados en este periodo activo.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRetirarEstudiante" tabindex="-1" aria-labelledby="modalRetirarLabel" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold" id="modalRetirarLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>Zona de Peligro: Retiro
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form method="POST" action="{% url 'admin_eliminar_estudiante' %}" id="formRetiro">
        {% csrf_token %}
        <div class="modal-body p-4">
            <div class="text-center mb-4">
                <div class="avatar-placeholder bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-user-graduate fa-3x text-secondary"></i>
                </div>
                <h4 class="fw-bold text-dark" id="nombreEstudianteModal">Cargando...</h4>
                <p class="text-muted small">Confirmación de salida institucional</p>
            </div>
            
            <div class="alert alert-warning border-warning">
                <h6 class="alert-heading fw-bold"><i class="fas fa-info-circle"></i> Protocolo de Retiro:</h6>
                <ul class="mb-0 small text-dark">
                    <li>El estudiante se moverá a <strong>Ex-Alumnos</strong>.</li>
                    <li>Se generarán y archivarán sus <strong>Boletines</strong>.</li>
                    <li>Se congelará su <strong>Observador Disciplinario</strong> actual.</li>
                    <li>Se desactivará el acceso a la plataforma.</li>
                </ul>
            </div>
            
            <input type="hidden" name="estudiante_id" id="idEstudianteRetirar" value="">
            
            <div class="form-check mt-3">
                <input class="form-check-input" type="checkbox" id="checkConfirm" required>
                <label class="form-check-label small" for="checkConfirm">
                    Confirmo que he verificado la identidad del estudiante y deseo proceder.
                </label>
            </div>
        </div>
        <div class="modal-footer bg-light">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger fw-bold" id="btnConfirmarRetiro" disabled>
                <i class="fas fa-archive me-2"></i>Ejecutar Retiro
            </button>
        </div>
      </form>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Estilos para Select2 Single (Curso) */
    .select2-container .select2-selection--single { 
        height: 38px; 
        border: 1px solid #ced4da; 
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered { 
        line-height: 36px; 
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow { 
        height: 36px; 
    }

    /* NUEVO: Estilos para Select2 Multiple (Estudiantes) */
    .select2-container .select2-selection--multiple {
        min-height: 38px;
        border: 1px solid #ced4da;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        color: #495057;
    }

    .cursor-pointer { cursor: pointer; }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Select2
    $('.select2').select2({ width: '100%', dropdownParent: $('body') });

    // Lógica del Modal
    var modalElement = document.getElementById('modalRetirarEstudiante');
    var checkConfirm = document.getElementById('checkConfirm');
    var btnConfirmar = document.getElementById('btnConfirmarRetiro');

    if (modalElement) {
        modalElement.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-estudiante-id');
            var nombre = button.getAttribute('data-estudiante-nombre');
            
            document.getElementById('nombreEstudianteModal').textContent = nombre;
            document.getElementById('idEstudianteRetirar').value = id;
            
            checkConfirm.checked = false;
            btnConfirmar.disabled = true;
        });
    }

    if(checkConfirm){
        checkConfirm.addEventListener('change', function() {
            btnConfirmar.disabled = !this.checked;
        });
    }

    // Lógica Toggles (Permisos)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const toggles = document.querySelectorAll('.toggle-permiso');
    toggles.forEach(switchEl => {
        switchEl.addEventListener('change', async function(e) {
            const estudianteId = e.target.dataset.estudianteId;
            const nuevoEstado = e.target.checked;
            const tipo = e.target.dataset.tipo;
            
            let urlApi = (tipo === 'boletin') 
                ? "{% url 'panel_api_toggle_boletin_permiso' %}" 
                : "{% url 'panel_api_toggle_observador' %}";

            try {
                const response = await fetch(urlApi, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ 'estudiante_id': estudianteId, 'estado': nuevoEstado })
                });
                const data = await response.json();
                if (!response.ok || data.status !== 'ok') throw new Error();
            } catch (error) {
                e.target.checked = !nuevoEstado;
                alert('No se pudo actualizar el permiso.');
            }
        });
    });
});
</script>
{% endblock %}