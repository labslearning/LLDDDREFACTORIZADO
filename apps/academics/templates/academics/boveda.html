{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<div class="container py-5" style="max-width: 1200px;">
    
    <div class="d-flex justify-content-between align-items-center mb-5 animate__animated animate__fadeInDown">
        <div class="d-flex align-items-center">
            <div class="icon-box bg-gradient-vault text-white rounded-circle p-3 me-3 shadow-lg" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-shield-alt fa-2x"></i>
            </div>
            <div>
                <h6 class="text-uppercase text-primary fw-bold ls-2 mb-1">Custodia de Activos Digitales</h6>
                <h1 class="fw-black text-dark mb-0">Bóveda Institucional</h1>
            </div>
        </div>
        <div class="text-end">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">
                    <i class="fas fa-microchip me-2 text-primary"></i> Engine v2.5
                </span>
                <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill fw-bold animate__animated animate__pulse animate__infinite">
                    <i class="fas fa-lock me-2"></i> ENCRIPTACIÓN ACTIVA
                </span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-2xl rounded-5 overflow-hidden h-100 animate__animated animate__fadeInLeft">
                <div class="card-header bg-primary text-white py-4 px-4 border-0 position-relative overflow-hidden">
                    <div class="position-relative z-1">
                        <h5 class="fw-black mb-1"><i class="fas fa-plus-circle me-2"></i>Nuevo Respaldo</h5>
                        <p class="mb-0 opacity-75 small">Generar copia inmutable bajo demanda.</p>
                    </div>
                    <i class="fas fa-server position-absolute text-white opacity-10" style="font-size: 8rem; right: -20px; bottom: -20px;"></i>
                </div>
                
                <div class="card-body p-4 bg-white">
                    <form method="POST">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label class="form-label small text-uppercase fw-bold text-muted ls-1">Identificador del Activo</label>
                            <input type="text" name="nombre_respaldo" 
                                   class="form-control form-control-lg fw-bold bg-light border-0" 
                                   placeholder="Ej: Corte_Periodo_2_Agosto" required>
                            <div class="form-text small"><i class="fas fa-info-circle me-1"></i> Se añadirá automáticamente UUID y Fecha.</div>
                        </div>

                        <div class="card bg-light border-0 mb-4 rounded-3">
                            <div class="card-body p-3">
                                <h6 class="fw-bold text-dark mb-2 small text-uppercase">Contenido del Paquete</h6>
                                <ul class="list-unstyled mb-0 small text-muted">
                                    <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Base de Datos (JSON Crudo)</li>
                                    <li class="mb-1"><i class="fas fa-check text-success me-2"></i>Boletines PDF (Históricos)</li>
                                    <li><i class="fas fa-check text-success me-2"></i>Manifiesto de Integridad (SHA-256)</li>
                                </ul>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill shadow-lg fw-black hover-lift">
                                <i class="fas fa-cogs me-2"></i> EJECUTAR SNAPSHOT
                            </button>
                        </div>
                    </form>
                </div>
                <div class="card-footer bg-light p-3 text-center border-0">
                    <small class="text-muted x-small">
                        <i class="fas fa-fingerprint me-1"></i> Su IP ({{ request.META.REMOTE_ADDR }}) quedará registrada.
                    </small>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card border-0 shadow-lg rounded-5 overflow-hidden h-100 animate__animated animate__fadeInRight">
                <div class="card-header bg-white py-3 px-4 border-bottom d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0"><i class="fas fa-history me-2 text-primary"></i>Inventario de Activos</h6>
                    <span class="badge bg-secondary rounded-pill">{{ respaldos|length }} Archivos</span>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-muted x-small text-uppercase">
                            <tr>
                                <th class="ps-4">Identificador / UUID</th>
                                <th>Metadatos</th>
                                <th>Integridad</th>
                                <th class="text-end pe-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in respaldos %}
                            <tr>
                                <td class="ps-4 py-3">
                                    <div class="fw-bold text-dark mb-0">{{ item.nombre_identificador }}</div>
                                    <div class="text-muted x-small font-monospace text-uppercase opacity-75">
                                        {{ item.uuid_operacion|stringformat:"s"|slice:":8" }}...
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column small">
                                        <span class="text-dark fw-bold">{{ item.fecha_generacion|date:"d M Y, H:i" }}</span>
                                        <span class="text-muted">Por: {{ item.generado_por.username }}</span>
                                        <span class="text-muted">{{ item.tamanio_mb|floatformat:2 }} MB</span>
                                    </div>
                                </td>
                                <td>
                                    <form action="{% url 'verificar_integridad' item.uuid_operacion %}" method="POST" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-light border rounded-pill px-3 fw-bold text-secondary hover-verify" title="Verificar Sello SHA-256">
                                            <i class="fas fa-shield-virus me-1"></i> Verificar
                                        </button>
                                    </form>
                                </td>
                                <td class="text-end pe-4">
                                    <a href="{{ item.archivo_zip.url }}" class="btn btn-primary btn-sm rounded-pill px-3 shadow-sm fw-bold hover-scale" download>
                                        <i class="fas fa-download me-2"></i> Descargar
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <div class="text-muted opacity-50">
                                        <i class="fas fa-box-open fa-3x mb-3"></i>
                                        <p class="mb-0">La bóveda está vacía.</p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<style>
    /* Diseño Industrial Bóveda */
    .bg-gradient-vault { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); }
    .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    .ls-1 { letter-spacing: 1px; }
    .ls-2 { letter-spacing: 2px; }
    .fw-black { font-weight: 900; }
    
    .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(13, 110, 253, 0.3) !important; transition: all 0.3s ease; }
    .hover-scale:hover { transform: scale(1.05); transition: all 0.2s ease; }
    
    .hover-verify:hover { 
        background-color: #d1e7dd !important; 
        color: #0f5132 !important; 
        border-color: #badbcc !important;
        transition: all 0.2s ease;
    }
    
    /* Font Monospace para UUIDs */
    .font-monospace { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; }
</style>
{% endblock %}
